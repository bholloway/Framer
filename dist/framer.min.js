/*

 JS Signals <http://millermedeiros.github.com/js-signals/>
 Released under the MIT license
 Author: Miller Medeiros
 Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
*/
(function(i){function h(a,b,c,d,e){this._listener=b;this._isOnce=c;this.context=d;this._signal=a;this._priority=e||0}function g(a,b){if(typeof a!=="function")throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",b));}function e(){this._bindings=[];this._prevParams=null;var a=this;this.dispatch=function(){e.prototype.dispatch.apply(a,arguments)}}h.prototype={active:!0,params:null,execute:function(a){var b;this.active&&this._listener&&(a=this.params?this.params.concat(a):
a,b=this._listener.apply(this.context,a),this._isOnce&&this.detach());return b},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal;delete this._listener;delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+
", isBound:"+this.isBound()+", active:"+this.active+"]"}};e.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(a,b,c,d){var e=this._indexOfListener(a,c);if(e!==-1){if(a=this._bindings[e],a.isOnce()!==b)throw Error("You cannot add"+(b?"":"Once")+"() then add"+(!b?"":"Once")+"() the same listener without removing the relationship first.");}else a=new h(this,a,b,c,d),this._addBinding(a);this.memorize&&this._prevParams&&a.execute(this._prevParams);return a},
_addBinding:function(a){var b=this._bindings.length;do--b;while(this._bindings[b]&&a._priority<=this._bindings[b]._priority);this._bindings.splice(b+1,0,a)},_indexOfListener:function(a,b){for(var c=this._bindings.length,d;c--;)if(d=this._bindings[c],d._listener===a&&d.context===b)return c;return-1},has:function(a,b){return this._indexOfListener(a,b)!==-1},add:function(a,b,c){g(a,"add");return this._registerListener(a,!1,b,c)},addOnce:function(a,b,c){g(a,"addOnce");return this._registerListener(a,
!0,b,c)},remove:function(a,b){g(a,"remove");var c=this._indexOfListener(a,b);c!==-1&&(this._bindings[c]._destroy(),this._bindings.splice(c,1));return a},removeAll:function(){for(var a=this._bindings.length;a--;)this._bindings[a]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(a){if(this.active){var b=Array.prototype.slice.call(arguments),c=this._bindings.length,d;if(this.memorize)this._prevParams=
b;if(c){d=this._bindings.slice();this._shouldPropagate=!0;do c--;while(d[c]&&this._shouldPropagate&&d[c].execute(b)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll();delete this._bindings;delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var f=e;f.Signal=e;typeof define==="function"&&define.amd?define(function(){return f}):typeof module!=="undefined"&&module.exports?module.exports=f:i.signals=
f})(this);
window.framer = {
    managers: [],
    Manager: Manager,
    Client: Client,
    domLog: domLog
};

var ClientMessage = 'client';
var ManagerMessage = 'manager';

function Frame(type, name, src, options) {
    this.type = type;
    this.name = name;
    this.src = src;
    this.options = options;
    this.frameElement = undefined;
}

function FrameMessage(type, data, origin, target, messenger) {
    this.type = type;
    this.data = data;
    this.origin = origin;
    this.target = target;
    this.messenger = messenger;
}
function closeFrameWindow(frame) {
    setTimeout(function () {
        try {
            frame.frameElement.src = 'about:blank';
        }
        catch (ex) {
            // Do nothing
        }
        setTimeout(function () {
            frame.frameElement.parentNode.removeChild(frame.frameElement);
            frame.frameElement = undefined;
        }, 100);
    }, 0);
}

function createUrlArgs(args) {
    var argsList = [];
    var properties = Object.getOwnPropertyNames(args);

    properties.forEach(function propertyResolver(name) {
        var encodedArg = name + '=' + encodeURI(args[name]);
        argsList.push(encodedArg);
    });

    return argsList.join('&');
}

function mergeOptions(existing, custom) {
    var keys = Object.getOwnPropertyNames(custom);
    keys.forEach(function (key) {
        if (typeof existing[key] === 'undefined') {
            existing[key] = custom[key];
        }
    });
}

function filterByKeyValue(collection, key, value, last) {
    var needle;
    var result = collection.filter(function (item) {
        return item[key] === value;
    });

    if (result.length > 0) {
        var resultIndex = 0;
        if (last) {
            resultIndex = result.length - 1;
        }
        needle = result[resultIndex];
    }
    return needle;
}

function parseParams(hash) {
    hash = hash || resolveHashSearch();
    var parameters = [];

    var segments = parseUris(hash);
    for (var name in segments) {
        parameters.push({
            name: name,
            data: segments[name]
        });
    }

    return parameters;
}

function resolveHashSearch() {
    if (document.location.search !== '') {
        return document.location.search;
    } else {
        var hash = document.location.hash;
        var strippedHash = hash.substring(hash.indexOf('?') + 1, hash.length);
        return strippedHash;
    }
}

function tryDecodeURIComponent(value) {
    try {
        return decodeURIComponent(value);
    } catch (error) {
        console.error('There was an issue parsing the uri segment, check your iframe src', error);
    }
}

function parseUris(keyValue) {
    keyValue = keyValue.replace(/^\?/, '');
    var segmentResults = {}, value, key;
    var segments = (keyValue || "").split('&');
    for (var i = 0; i < segments.length; i++) {
        var kValue = segments[i];
        if (kValue) {
            value = kValue.replace(/\+/g, '%20').split('=');
            key = tryDecodeURIComponent(value[0]);
            if (isDefined(key)) {
                var val = isDefined(value[1]) ? tryDecodeURIComponent(value[1]) : true;
                if (!hasOwnProperty.call(segmentResults, key)) {
                    segmentResults[key] = val;
                } else if (isArray(segmentResults[key])) {
                    segmentResults[key].push(val);
                } else {
                    segmentResults[key] = [segmentResults[key], val];
                }
            }
        }
    }
    return segmentResults;
}

function prependElement(parentElement, element) {
    return parentElement.insertBefore(element, parentElement.firstChild);
}

function setElementStyles(element, styles) {
    for (var style in styles) {
        element.style[style] = styles[style];
    }
}

function setElementAttributes(element, attributes) {
    for (var attribute in attributes) {
        element.setAttribute(attribute, attributes[attribute]);
    }
    return element;
}

function elementExistsByClassName(className) {
    var existingElements = window.document.getElementsByClassName(className);
    return existingElements.length > 0;
}

function isDefined(value) {
    return typeof value !== 'undefined';
}

/**
 * Simple utility to log messages to the dom.
 * @param message
 * @param color
 */
function domLog(message, color) {
    var className = 'dom-log';
    var container = document.getElementsByClassName(className)[0];
    if (!container) {
        container = document.createElement('div');
        container.className = className;
        container.style.position = 'absolute';
        container.style.top = '0';
        container.style.right = '0';
        prependElement(window.document.body, container);
    }

    var logMessage = document.createElement('p');
    logMessage.innerText = message;
    logMessage.style.color = color;
    logMessage.style.fontSize = '0.5em';
    container.appendChild(logMessage);
}

/**
 * Manager is the manager of a set of iframe/webview elements
 * that can communicate with send and receive.
 *
 * @param name
 * @constructor
 */
function Manager(name) {
    this.name = name;
    this.frames = [];
    this.handlers = [];
    this.focus = null;
    this.persistentFrame = null;
    this.zIndex = 99999;
    this.container = this.createFrameContainer(this.name);
    // The default style will make the frames fullscreen as if this is a
    // single frame application ;)
    this.style = {
        position: 'fixed',
        top: '0px',
        left: '0px',
        bottom: '0px',
        right: '0px',
        width: '100%',
        height: '100%',
        border: 'none',
        margin: '0',
        padding: '0',
        overflow: 'hidden'
    };

    this.listen();

    var Signal = signals.Signal;
    this.closed = new Signal();
    this.opened = new Signal();

    window.framer.managers.push(this);
}

Manager.prototype.receiveMessage = function (event) {
    if (event.origin !== document.location.origin) {
        return;
    }

    if (event.data.messenger === ClientMessage &&
        (event.data.target === this.name || typeof event.data.target === 'undefined')) {
        this.handleMessage(event.data);
    }
};

Manager.prototype.destroy = function() {
    this.unListen();
};

Manager.prototype.listen = function() {
    this.listener = function(event){
        this.receiveMessage(event);
    }.bind(this);

    window.top.addEventListener('message', this.listener, false);
};

Manager.prototype.unListen = function() {
    window.top.removeEventListener('message', this.listener);
    this.listener = undefined;
};

/**
 * Send a message to a Client, if no target is specified send to all.
 * @param type the message type to use based that describes the feature, eg submit, send, logout
 * @param data the oat
 * @param target
 */
Manager.prototype.send = function (type, data, target) {
    var message = new FrameMessage(type, data, this.name, target, ManagerMessage);
    window.top.postMessage(message, document.location.origin);
};

/**
 * Receive a message on a Manager instance. The callback will recieve the data
 * value sent with Manager.prototype.send()
 * @param type
 * @param callback
 */
Manager.prototype.receive = function (type, callback) {
    if (!filterByKeyValue(this.handlers, 'type', type)) {
        this.handlers.push({
            type: type,
            callback: callback
        });
    } else {
        console.error('You already have a callback for type', type);
    }
};

/**
 * Add a new frame to the Manager instance.
 *
 * @param name the unique name to manage and recieve messages
 * @param src the src url that is given to the iframe/webview
 * @param options an object with values for style, attributes and url arguments for the src
 * @returns {*}
 */
Manager.prototype.add = function (name, src, options) {
    var existing = filterByKeyValue(this.frames, 'name', name);
    if (existing) {
        console.warn('Manager.add() there is already a frame named',
            name, 'in the framer', this.name);
        return existing;
    }
    options = options || {};

    if (!isDefined(options.style)) {
        options.style = this.style;
    }
    if (!isDefined(options.append)) {
        options.append = true;
    }
    if (!isDefined(options.persistent)) {
        options.persistent = true;
    }

    var frame = new Frame(ClientMessage, name, src, options);
    this.frames.push(frame);

    return frame;
};

/**
 * Open a frame by name and close any opened frames.
 *
 * @param name
 * @param options
 */
Manager.prototype.open = function (name, options) {
    var existing = this.getFrame(name);
    if (!existing) {
        console.error('Manager open() there is no frame with that name', name);
        return;
    }
    if (this.focus && this.focus !== existing) {
        this.closeFrame(this.focus);
    }
    this.focus = existing;

    if (options) {
        mergeOptions(this.focus.options, options);
    }
    this.openFrame(this.focus);

    this.opened.dispatch(existing);

    return existing;
};

/**
 * Open a frame by name and instead of closing any opened frames,
 * this frame will instead open at a zIndex above the existing opened frame.
 *
 * @param name
 * @param options
 */
Manager.prototype.openAbove = function (name, options) {
    options = options || {};
    options.style = options.style || {};

    var existing = this.getFrame(name);
    if (!existing) {
        console.error('Manager open() there is no frame with that name', name);
        return;
    }
    if (!options.style.zIndex) {
        options.style.zIndex = existing.style.zIndex + 1;
    }
    this.openFrame(existing, options);

    return existing;
};

Manager.prototype.close = function (name) {
    var existing = this.getFrame(name);
    if (!existing) {
        console.warn('Manager close() there is no frame with that name', name);
        return;
    }
    this.closeFrame(existing);
    this.focus = null;

    this.closed.dispatch(existing);
};

Manager.prototype.handleMessage = function (message) {
    var result = filterByKeyValue(this.handlers, 'type', message.type);
    if (result) {
        result.callback.apply(this, [message.data]);
    }
};

Manager.prototype.openFrame = function (frame, options) {
    //merge existing options with override
    if (options) {
        mergeOptions(frame.options, options);
    }

    if(frame.options.persistent) {
        this.setPersistentFrame(frame);

    } else if (!frame.frameElement) {
        this.createFrameElement(frame);
        if (frame.options.append) {
            var parent = this.container;
            if (frame.options.parent) {
                parent = frame.options.parent;
            }
            prependElement(parent, frame.frameElement);
        }
    } else {
        console.warn('Manager', this.name, 'already has', frame.name, 'open');
    }
};

Manager.prototype.closeFrame = function (frame) {
    if(frame.options.persistent && this.persistentFrame !== null) {
        this.persistentFrame.src = 'about:blank';
        this.persistentFrame.style.visibility = 'hidden';

    } else if(frame.frameElement) {
        var childWindow = frame.frameElement.contentWindow;
        console.log('frame options', frame.options);
        //if (frame.options.angularAppId && childWindow.angular) {
        //    angularCloseFrameWindow(frame);
        //}
        //else {
            closeFrameWindow(frame);
        //}
    } else {
        console.warn('Manager', this.name, 'frame', frame.name, 'is not open to close');
    }
};

Manager.prototype.getFrame = function (frame) {
    var existingFrame;
    if (typeof frame === 'string') {
        existingFrame = this.getFrameByName(frame)
    } else if (Object.getOwnPropertyNames(frame).name) {
        existingFrame = this.frames.indexOf(frame);
    }

    return existingFrame;
};

Manager.prototype.getFrameByName = function (name) {
    var frame;
    var result = this.frames.filter(function (frame) {
        return frame.name === name;
    });
    if (result.length > 0) {
        frame = result[0];
    }

    return frame;
};

Manager.prototype.setPersistentFrame = function(frame) {
    if(this.persistentFrame === null) {
        this.persistentFrame = document.createElement('iframe');
        prependElement(this.container, this.persistentFrame);
    }

    var src = frame.src;
    var options = frame.options;
    options.arguments = options.arguments || {};
    options.style = options.style || {};
    options.attributes = options.attributes || {};
    var parameters = createUrlArgs(options.arguments);
    var params = '&name=' + frame.name + '&' + parameters;
    var origin = '?origin=' + encodeURIComponent(document.location.href);

    setElementStyles(this.persistentFrame, options.style);
    setElementAttributes(this.persistentFrame, options.attributes);

    this.persistentFrame.id = frame.name;
    this.persistentFrame.src = src + origin + params;
    this.persistentFrame.style.visibility = 'visible';
    this.persistentFrame.sandbox = 'allow-forms allow-scripts allow-same-origin';
    frame.frameElement = this.persistentFrame;

};

Manager.prototype.createFrameElement = function (frame) {
    var src = frame.src;
    var options = frame.options;
    options.arguments = options.arguments || {};
    options.style = options.style || {};
    options.attributes = options.attributes || {};
    var parameters = createUrlArgs(options.arguments);
    var params = '&name=' + frame.name + '&' + parameters;
    var origin = '?origin=' + encodeURIComponent(document.location.href);

    //todo webview ms-app-webview
    var iframe = document.createElement('iframe');

    setElementStyles(iframe, options.style);
    setElementAttributes(iframe, options.attributes);

    iframe.id = frame.name;
    iframe.src = src + origin + params;
    iframe.sandbox = 'allow-forms allow-scripts allow-same-origin';
    frame.frameElement = iframe;

    return frame;
};



Manager.prototype.createFrameContainer = function (className) {
    var container;
    if (!elementExistsByClassName(className)) {
        container = window.document.createElement('div');
        container.className = className;
        container.style.position = 'fixed';
        container.style.top = 0;
        container.style.left = 0;
        container.style.zIndex = this.zIndex;
        prependElement(window.document.body, container);
    }
    return container;
};
function Client() {
    this.handlers = [];

    this.params = parseParams();
    var name = filterByKeyValue(this.params, 'name', 'name', true);
    var origin = filterByKeyValue(this.params, 'name', 'origin');
    if (!isDefined(name) || !isDefined(origin)) {
        console.info('A Framer Client will not work without the correct origin and name url args, origin and name');
        return;
    }
    this.name = name.data;
    this.origin = origin.data;

    this.listen();
}

Client.prototype.receiveMessage = function (event) {
    if (event &&
        event.origin &&
        event.origin !== window.top.document.location.origin) {
        return;
    }

    if (event.data.messenger === ManagerMessage &&
        (event.data.target === this.name ||
        typeof event.data.target === 'undefined')) {
        this.handleMessage(event.data);
    }
};

Client.prototype.destroy = function() {
    this.unListen();
};

Client.prototype.listen = function() {
    this.listener = function(event){
        this.receiveMessage(event);
    }.bind(this);

    window.top.addEventListener('message', this.listener, false);
};

Client.prototype.unListen = function() {
    window.top.removeEventListener('message', this.listener);
    this.listener = undefined;
};

Client.prototype.handleMessage = function (message) {
    var result = filterByKeyValue(this.handlers, 'type', message.type);
    if (result) {
        result.callback.apply(this, [message.data]);
    }
};

Client.prototype.send = function (type, data, target) {
    var message = new FrameMessage(type, data, this.name, target, ClientMessage);
    window.top.postMessage(message, this.origin);
};

Client.prototype.receive = function (type, callback) {
    if (!filterByKeyValue(this.handlers, 'type', type)) {
        this.handlers.push({
            type: type,
            callback: callback
        });
    } else {
        console.error('You already have a callback for type', name);
    }
};
function angularCloseFrameWindow(frame) {
    var childWindow = frame.frameElement.contentWindow;
    var ngApp = childWindow.angular.element(childWindow.document.getElementById(frame.options.angularAppId));
    console.log('ngApp', ngApp);

    var injector = childWindow.angular.element(ngApp).injector();
    destroyAllScopes();

    function destroyAllScopes() {
        var rootScope = injector.get('$rootScope');
        rootScope.$broadcast("$destroy");
        setTimeout(function () {
            closeFrameWindow(frame);
        }, 0);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpZ25hbHMubWluLmpzIiwiRnJhbWVyLmpzIiwidXRpbC5qcyIsIk1hbmFnZXIuanMiLCJDbGllbnQuanMiLCJhbmd1bGFyLWZyYW1lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNiQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDN0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pVQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZnJhbWVyLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5cbiBKUyBTaWduYWxzIDxodHRwOi8vbWlsbGVybWVkZWlyb3MuZ2l0aHViLmNvbS9qcy1zaWduYWxzLz5cbiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2VcbiBBdXRob3I6IE1pbGxlciBNZWRlaXJvc1xuIFZlcnNpb246IDEuMC4wIC0gQnVpbGQ6IDI2OCAoMjAxMi8xMS8yOSAwNTo0OCBQTSlcbiovXG4oZnVuY3Rpb24oaSl7ZnVuY3Rpb24gaChhLGIsYyxkLGUpe3RoaXMuX2xpc3RlbmVyPWI7dGhpcy5faXNPbmNlPWM7dGhpcy5jb250ZXh0PWQ7dGhpcy5fc2lnbmFsPWE7dGhpcy5fcHJpb3JpdHk9ZXx8MH1mdW5jdGlvbiBnKGEsYil7aWYodHlwZW9mIGEhPT1cImZ1bmN0aW9uXCIpdGhyb3cgRXJyb3IoXCJsaXN0ZW5lciBpcyBhIHJlcXVpcmVkIHBhcmFtIG9mIHtmbn0oKSBhbmQgc2hvdWxkIGJlIGEgRnVuY3Rpb24uXCIucmVwbGFjZShcIntmbn1cIixiKSk7fWZ1bmN0aW9uIGUoKXt0aGlzLl9iaW5kaW5ncz1bXTt0aGlzLl9wcmV2UGFyYW1zPW51bGw7dmFyIGE9dGhpczt0aGlzLmRpc3BhdGNoPWZ1bmN0aW9uKCl7ZS5wcm90b3R5cGUuZGlzcGF0Y2guYXBwbHkoYSxhcmd1bWVudHMpfX1oLnByb3RvdHlwZT17YWN0aXZlOiEwLHBhcmFtczpudWxsLGV4ZWN1dGU6ZnVuY3Rpb24oYSl7dmFyIGI7dGhpcy5hY3RpdmUmJnRoaXMuX2xpc3RlbmVyJiYoYT10aGlzLnBhcmFtcz90aGlzLnBhcmFtcy5jb25jYXQoYSk6XG5hLGI9dGhpcy5fbGlzdGVuZXIuYXBwbHkodGhpcy5jb250ZXh0LGEpLHRoaXMuX2lzT25jZSYmdGhpcy5kZXRhY2goKSk7cmV0dXJuIGJ9LGRldGFjaDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmlzQm91bmQoKT90aGlzLl9zaWduYWwucmVtb3ZlKHRoaXMuX2xpc3RlbmVyLHRoaXMuY29udGV4dCk6bnVsbH0saXNCb3VuZDpmdW5jdGlvbigpe3JldHVybiEhdGhpcy5fc2lnbmFsJiYhIXRoaXMuX2xpc3RlbmVyfSxpc09uY2U6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5faXNPbmNlfSxnZXRMaXN0ZW5lcjpmdW5jdGlvbigpe3JldHVybiB0aGlzLl9saXN0ZW5lcn0sZ2V0U2lnbmFsOmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX3NpZ25hbH0sX2Rlc3Ryb3k6ZnVuY3Rpb24oKXtkZWxldGUgdGhpcy5fc2lnbmFsO2RlbGV0ZSB0aGlzLl9saXN0ZW5lcjtkZWxldGUgdGhpcy5jb250ZXh0fSx0b1N0cmluZzpmdW5jdGlvbigpe3JldHVyblwiW1NpZ25hbEJpbmRpbmcgaXNPbmNlOlwiK3RoaXMuX2lzT25jZStcblwiLCBpc0JvdW5kOlwiK3RoaXMuaXNCb3VuZCgpK1wiLCBhY3RpdmU6XCIrdGhpcy5hY3RpdmUrXCJdXCJ9fTtlLnByb3RvdHlwZT17VkVSU0lPTjpcIjEuMC4wXCIsbWVtb3JpemU6ITEsX3Nob3VsZFByb3BhZ2F0ZTohMCxhY3RpdmU6ITAsX3JlZ2lzdGVyTGlzdGVuZXI6ZnVuY3Rpb24oYSxiLGMsZCl7dmFyIGU9dGhpcy5faW5kZXhPZkxpc3RlbmVyKGEsYyk7aWYoZSE9PS0xKXtpZihhPXRoaXMuX2JpbmRpbmdzW2VdLGEuaXNPbmNlKCkhPT1iKXRocm93IEVycm9yKFwiWW91IGNhbm5vdCBhZGRcIisoYj9cIlwiOlwiT25jZVwiKStcIigpIHRoZW4gYWRkXCIrKCFiP1wiXCI6XCJPbmNlXCIpK1wiKCkgdGhlIHNhbWUgbGlzdGVuZXIgd2l0aG91dCByZW1vdmluZyB0aGUgcmVsYXRpb25zaGlwIGZpcnN0LlwiKTt9ZWxzZSBhPW5ldyBoKHRoaXMsYSxiLGMsZCksdGhpcy5fYWRkQmluZGluZyhhKTt0aGlzLm1lbW9yaXplJiZ0aGlzLl9wcmV2UGFyYW1zJiZhLmV4ZWN1dGUodGhpcy5fcHJldlBhcmFtcyk7cmV0dXJuIGF9LFxuX2FkZEJpbmRpbmc6ZnVuY3Rpb24oYSl7dmFyIGI9dGhpcy5fYmluZGluZ3MubGVuZ3RoO2RvLS1iO3doaWxlKHRoaXMuX2JpbmRpbmdzW2JdJiZhLl9wcmlvcml0eTw9dGhpcy5fYmluZGluZ3NbYl0uX3ByaW9yaXR5KTt0aGlzLl9iaW5kaW5ncy5zcGxpY2UoYisxLDAsYSl9LF9pbmRleE9mTGlzdGVuZXI6ZnVuY3Rpb24oYSxiKXtmb3IodmFyIGM9dGhpcy5fYmluZGluZ3MubGVuZ3RoLGQ7Yy0tOylpZihkPXRoaXMuX2JpbmRpbmdzW2NdLGQuX2xpc3RlbmVyPT09YSYmZC5jb250ZXh0PT09YilyZXR1cm4gYztyZXR1cm4tMX0saGFzOmZ1bmN0aW9uKGEsYil7cmV0dXJuIHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihhLGIpIT09LTF9LGFkZDpmdW5jdGlvbihhLGIsYyl7ZyhhLFwiYWRkXCIpO3JldHVybiB0aGlzLl9yZWdpc3Rlckxpc3RlbmVyKGEsITEsYixjKX0sYWRkT25jZTpmdW5jdGlvbihhLGIsYyl7ZyhhLFwiYWRkT25jZVwiKTtyZXR1cm4gdGhpcy5fcmVnaXN0ZXJMaXN0ZW5lcihhLFxuITAsYixjKX0scmVtb3ZlOmZ1bmN0aW9uKGEsYil7ZyhhLFwicmVtb3ZlXCIpO3ZhciBjPXRoaXMuX2luZGV4T2ZMaXN0ZW5lcihhLGIpO2MhPT0tMSYmKHRoaXMuX2JpbmRpbmdzW2NdLl9kZXN0cm95KCksdGhpcy5fYmluZGluZ3Muc3BsaWNlKGMsMSkpO3JldHVybiBhfSxyZW1vdmVBbGw6ZnVuY3Rpb24oKXtmb3IodmFyIGE9dGhpcy5fYmluZGluZ3MubGVuZ3RoO2EtLTspdGhpcy5fYmluZGluZ3NbYV0uX2Rlc3Ryb3koKTt0aGlzLl9iaW5kaW5ncy5sZW5ndGg9MH0sZ2V0TnVtTGlzdGVuZXJzOmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX2JpbmRpbmdzLmxlbmd0aH0saGFsdDpmdW5jdGlvbigpe3RoaXMuX3Nob3VsZFByb3BhZ2F0ZT0hMX0sZGlzcGF0Y2g6ZnVuY3Rpb24oYSl7aWYodGhpcy5hY3RpdmUpe3ZhciBiPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksYz10aGlzLl9iaW5kaW5ncy5sZW5ndGgsZDtpZih0aGlzLm1lbW9yaXplKXRoaXMuX3ByZXZQYXJhbXM9XG5iO2lmKGMpe2Q9dGhpcy5fYmluZGluZ3Muc2xpY2UoKTt0aGlzLl9zaG91bGRQcm9wYWdhdGU9ITA7ZG8gYy0tO3doaWxlKGRbY10mJnRoaXMuX3Nob3VsZFByb3BhZ2F0ZSYmZFtjXS5leGVjdXRlKGIpIT09ITEpfX19LGZvcmdldDpmdW5jdGlvbigpe3RoaXMuX3ByZXZQYXJhbXM9bnVsbH0sZGlzcG9zZTpmdW5jdGlvbigpe3RoaXMucmVtb3ZlQWxsKCk7ZGVsZXRlIHRoaXMuX2JpbmRpbmdzO2RlbGV0ZSB0aGlzLl9wcmV2UGFyYW1zfSx0b1N0cmluZzpmdW5jdGlvbigpe3JldHVyblwiW1NpZ25hbCBhY3RpdmU6XCIrdGhpcy5hY3RpdmUrXCIgbnVtTGlzdGVuZXJzOlwiK3RoaXMuZ2V0TnVtTGlzdGVuZXJzKCkrXCJdXCJ9fTt2YXIgZj1lO2YuU2lnbmFsPWU7dHlwZW9mIGRlZmluZT09PVwiZnVuY3Rpb25cIiYmZGVmaW5lLmFtZD9kZWZpbmUoZnVuY3Rpb24oKXtyZXR1cm4gZn0pOnR5cGVvZiBtb2R1bGUhPT1cInVuZGVmaW5lZFwiJiZtb2R1bGUuZXhwb3J0cz9tb2R1bGUuZXhwb3J0cz1mOmkuc2lnbmFscz1cbmZ9KSh0aGlzKTsiLCJ3aW5kb3cuZnJhbWVyID0ge1xyXG4gICAgbWFuYWdlcnM6IFtdLFxyXG4gICAgTWFuYWdlcjogTWFuYWdlcixcclxuICAgIENsaWVudDogQ2xpZW50LFxyXG4gICAgZG9tTG9nOiBkb21Mb2dcclxufTtcclxuXHJcbnZhciBDbGllbnRNZXNzYWdlID0gJ2NsaWVudCc7XHJcbnZhciBNYW5hZ2VyTWVzc2FnZSA9ICdtYW5hZ2VyJztcclxuXHJcbmZ1bmN0aW9uIEZyYW1lKHR5cGUsIG5hbWUsIHNyYywgb3B0aW9ucykge1xyXG4gICAgdGhpcy50eXBlID0gdHlwZTtcclxuICAgIHRoaXMubmFtZSA9IG5hbWU7XHJcbiAgICB0aGlzLnNyYyA9IHNyYztcclxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XHJcbiAgICB0aGlzLmZyYW1lRWxlbWVudCA9IHVuZGVmaW5lZDtcclxufVxyXG5cclxuZnVuY3Rpb24gRnJhbWVNZXNzYWdlKHR5cGUsIGRhdGEsIG9yaWdpbiwgdGFyZ2V0LCBtZXNzZW5nZXIpIHtcclxuICAgIHRoaXMudHlwZSA9IHR5cGU7XHJcbiAgICB0aGlzLmRhdGEgPSBkYXRhO1xyXG4gICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47XHJcbiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDtcclxuICAgIHRoaXMubWVzc2VuZ2VyID0gbWVzc2VuZ2VyO1xyXG59IiwiZnVuY3Rpb24gY2xvc2VGcmFtZVdpbmRvdyhmcmFtZSkge1xyXG4gICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZnJhbWUuZnJhbWVFbGVtZW50LnNyYyA9ICdhYm91dDpibGFuayc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChleCkge1xyXG4gICAgICAgICAgICAvLyBEbyBub3RoaW5nXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBmcmFtZS5mcmFtZUVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmcmFtZS5mcmFtZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICBmcmFtZS5mcmFtZUVsZW1lbnQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSwgMTAwKTtcclxuICAgIH0sIDApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVVcmxBcmdzKGFyZ3MpIHtcclxuICAgIHZhciBhcmdzTGlzdCA9IFtdO1xyXG4gICAgdmFyIHByb3BlcnRpZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhhcmdzKTtcclxuXHJcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goZnVuY3Rpb24gcHJvcGVydHlSZXNvbHZlcihuYW1lKSB7XHJcbiAgICAgICAgdmFyIGVuY29kZWRBcmcgPSBuYW1lICsgJz0nICsgZW5jb2RlVVJJKGFyZ3NbbmFtZV0pO1xyXG4gICAgICAgIGFyZ3NMaXN0LnB1c2goZW5jb2RlZEFyZyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gYXJnc0xpc3Quam9pbignJicpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtZXJnZU9wdGlvbnMoZXhpc3RpbmcsIGN1c3RvbSkge1xyXG4gICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhjdXN0b20pO1xyXG4gICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcclxuICAgICAgICBpZiAodHlwZW9mIGV4aXN0aW5nW2tleV0gPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgIGV4aXN0aW5nW2tleV0gPSBjdXN0b21ba2V5XTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZmlsdGVyQnlLZXlWYWx1ZShjb2xsZWN0aW9uLCBrZXksIHZhbHVlLCBsYXN0KSB7XHJcbiAgICB2YXIgbmVlZGxlO1xyXG4gICAgdmFyIHJlc3VsdCA9IGNvbGxlY3Rpb24uZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgcmV0dXJuIGl0ZW1ba2V5XSA9PT0gdmFsdWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICB2YXIgcmVzdWx0SW5kZXggPSAwO1xyXG4gICAgICAgIGlmIChsYXN0KSB7XHJcbiAgICAgICAgICAgIHJlc3VsdEluZGV4ID0gcmVzdWx0Lmxlbmd0aCAtIDE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5lZWRsZSA9IHJlc3VsdFtyZXN1bHRJbmRleF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmVlZGxlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVBhcmFtcyhoYXNoKSB7XHJcbiAgICBoYXNoID0gaGFzaCB8fCByZXNvbHZlSGFzaFNlYXJjaCgpO1xyXG4gICAgdmFyIHBhcmFtZXRlcnMgPSBbXTtcclxuXHJcbiAgICB2YXIgc2VnbWVudHMgPSBwYXJzZVVyaXMoaGFzaCk7XHJcbiAgICBmb3IgKHZhciBuYW1lIGluIHNlZ21lbnRzKSB7XHJcbiAgICAgICAgcGFyYW1ldGVycy5wdXNoKHtcclxuICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgZGF0YTogc2VnbWVudHNbbmFtZV1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFyYW1ldGVycztcclxufVxyXG5cclxuZnVuY3Rpb24gcmVzb2x2ZUhhc2hTZWFyY2goKSB7XHJcbiAgICBpZiAoZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoICE9PSAnJykge1xyXG4gICAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5zZWFyY2g7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhciBoYXNoID0gZG9jdW1lbnQubG9jYXRpb24uaGFzaDtcclxuICAgICAgICB2YXIgc3RyaXBwZWRIYXNoID0gaGFzaC5zdWJzdHJpbmcoaGFzaC5pbmRleE9mKCc/JykgKyAxLCBoYXNoLmxlbmd0aCk7XHJcbiAgICAgICAgcmV0dXJuIHN0cmlwcGVkSGFzaDtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdUaGVyZSB3YXMgYW4gaXNzdWUgcGFyc2luZyB0aGUgdXJpIHNlZ21lbnQsIGNoZWNrIHlvdXIgaWZyYW1lIHNyYycsIGVycm9yKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VVcmlzKGtleVZhbHVlKSB7XHJcbiAgICBrZXlWYWx1ZSA9IGtleVZhbHVlLnJlcGxhY2UoL15cXD8vLCAnJyk7XHJcbiAgICB2YXIgc2VnbWVudFJlc3VsdHMgPSB7fSwgdmFsdWUsIGtleTtcclxuICAgIHZhciBzZWdtZW50cyA9IChrZXlWYWx1ZSB8fCBcIlwiKS5zcGxpdCgnJicpO1xyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHZhciBrVmFsdWUgPSBzZWdtZW50c1tpXTtcclxuICAgICAgICBpZiAoa1ZhbHVlKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0ga1ZhbHVlLnJlcGxhY2UoL1xcKy9nLCAnJTIwJykuc3BsaXQoJz0nKTtcclxuICAgICAgICAgICAga2V5ID0gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlWzBdKTtcclxuICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdmFsID0gaXNEZWZpbmVkKHZhbHVlWzFdKSA/IHRyeURlY29kZVVSSUNvbXBvbmVudCh2YWx1ZVsxXSkgOiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKHNlZ21lbnRSZXN1bHRzLCBrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VnbWVudFJlc3VsdHNba2V5XSA9IHZhbDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShzZWdtZW50UmVzdWx0c1trZXldKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlZ21lbnRSZXN1bHRzW2tleV0ucHVzaCh2YWwpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzZWdtZW50UmVzdWx0c1trZXldID0gW3NlZ21lbnRSZXN1bHRzW2tleV0sIHZhbF07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2VnbWVudFJlc3VsdHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHByZXBlbmRFbGVtZW50KHBhcmVudEVsZW1lbnQsIGVsZW1lbnQpIHtcclxuICAgIHJldHVybiBwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShlbGVtZW50LCBwYXJlbnRFbGVtZW50LmZpcnN0Q2hpbGQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRFbGVtZW50U3R5bGVzKGVsZW1lbnQsIHN0eWxlcykge1xyXG4gICAgZm9yICh2YXIgc3R5bGUgaW4gc3R5bGVzKSB7XHJcbiAgICAgICAgZWxlbWVudC5zdHlsZVtzdHlsZV0gPSBzdHlsZXNbc3R5bGVdO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRFbGVtZW50QXR0cmlidXRlcyhlbGVtZW50LCBhdHRyaWJ1dGVzKSB7XHJcbiAgICBmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykge1xyXG4gICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZSwgYXR0cmlidXRlc1thdHRyaWJ1dGVdKTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbGVtZW50O1xyXG59XHJcblxyXG5mdW5jdGlvbiBlbGVtZW50RXhpc3RzQnlDbGFzc05hbWUoY2xhc3NOYW1lKSB7XHJcbiAgICB2YXIgZXhpc3RpbmdFbGVtZW50cyA9IHdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSk7XHJcbiAgICByZXR1cm4gZXhpc3RpbmdFbGVtZW50cy5sZW5ndGggPiAwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHtcclxuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnO1xyXG59XHJcblxyXG4vKipcclxuICogU2ltcGxlIHV0aWxpdHkgdG8gbG9nIG1lc3NhZ2VzIHRvIHRoZSBkb20uXHJcbiAqIEBwYXJhbSBtZXNzYWdlXHJcbiAqIEBwYXJhbSBjb2xvclxyXG4gKi9cclxuZnVuY3Rpb24gZG9tTG9nKG1lc3NhZ2UsIGNvbG9yKSB7XHJcbiAgICB2YXIgY2xhc3NOYW1lID0gJ2RvbS1sb2cnO1xyXG4gICAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKVswXTtcclxuICAgIGlmICghY29udGFpbmVyKSB7XHJcbiAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgY29udGFpbmVyLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcclxuICAgICAgICBjb250YWluZXIuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xyXG4gICAgICAgIGNvbnRhaW5lci5zdHlsZS50b3AgPSAnMCc7XHJcbiAgICAgICAgY29udGFpbmVyLnN0eWxlLnJpZ2h0ID0gJzAnO1xyXG4gICAgICAgIHByZXBlbmRFbGVtZW50KHdpbmRvdy5kb2N1bWVudC5ib2R5LCBjb250YWluZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBsb2dNZXNzYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgbG9nTWVzc2FnZS5pbm5lclRleHQgPSBtZXNzYWdlO1xyXG4gICAgbG9nTWVzc2FnZS5zdHlsZS5jb2xvciA9IGNvbG9yO1xyXG4gICAgbG9nTWVzc2FnZS5zdHlsZS5mb250U2l6ZSA9ICcwLjVlbSc7XHJcbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQobG9nTWVzc2FnZSk7XHJcbn0iLCJcclxuLyoqXHJcbiAqIE1hbmFnZXIgaXMgdGhlIG1hbmFnZXIgb2YgYSBzZXQgb2YgaWZyYW1lL3dlYnZpZXcgZWxlbWVudHNcclxuICogdGhhdCBjYW4gY29tbXVuaWNhdGUgd2l0aCBzZW5kIGFuZCByZWNlaXZlLlxyXG4gKlxyXG4gKiBAcGFyYW0gbmFtZVxyXG4gKiBAY29uc3RydWN0b3JcclxuICovXHJcbmZ1bmN0aW9uIE1hbmFnZXIobmFtZSkge1xyXG4gICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICAgIHRoaXMuZnJhbWVzID0gW107XHJcbiAgICB0aGlzLmhhbmRsZXJzID0gW107XHJcbiAgICB0aGlzLmZvY3VzID0gbnVsbDtcclxuICAgIHRoaXMucGVyc2lzdGVudEZyYW1lID0gbnVsbDtcclxuICAgIHRoaXMuekluZGV4ID0gOTk5OTk7XHJcbiAgICB0aGlzLmNvbnRhaW5lciA9IHRoaXMuY3JlYXRlRnJhbWVDb250YWluZXIodGhpcy5uYW1lKTtcclxuICAgIC8vIFRoZSBkZWZhdWx0IHN0eWxlIHdpbGwgbWFrZSB0aGUgZnJhbWVzIGZ1bGxzY3JlZW4gYXMgaWYgdGhpcyBpcyBhXHJcbiAgICAvLyBzaW5nbGUgZnJhbWUgYXBwbGljYXRpb24gOylcclxuICAgIHRoaXMuc3R5bGUgPSB7XHJcbiAgICAgICAgcG9zaXRpb246ICdmaXhlZCcsXHJcbiAgICAgICAgdG9wOiAnMHB4JyxcclxuICAgICAgICBsZWZ0OiAnMHB4JyxcclxuICAgICAgICBib3R0b206ICcwcHgnLFxyXG4gICAgICAgIHJpZ2h0OiAnMHB4JyxcclxuICAgICAgICB3aWR0aDogJzEwMCUnLFxyXG4gICAgICAgIGhlaWdodDogJzEwMCUnLFxyXG4gICAgICAgIGJvcmRlcjogJ25vbmUnLFxyXG4gICAgICAgIG1hcmdpbjogJzAnLFxyXG4gICAgICAgIHBhZGRpbmc6ICcwJyxcclxuICAgICAgICBvdmVyZmxvdzogJ2hpZGRlbidcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5saXN0ZW4oKTtcclxuXHJcbiAgICB2YXIgU2lnbmFsID0gc2lnbmFscy5TaWduYWw7XHJcbiAgICB0aGlzLmNsb3NlZCA9IG5ldyBTaWduYWwoKTtcclxuICAgIHRoaXMub3BlbmVkID0gbmV3IFNpZ25hbCgpO1xyXG5cclxuICAgIHdpbmRvdy5mcmFtZXIubWFuYWdlcnMucHVzaCh0aGlzKTtcclxufVxyXG5cclxuTWFuYWdlci5wcm90b3R5cGUucmVjZWl2ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIGlmIChldmVudC5vcmlnaW4gIT09IGRvY3VtZW50LmxvY2F0aW9uLm9yaWdpbikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZXZlbnQuZGF0YS5tZXNzZW5nZXIgPT09IENsaWVudE1lc3NhZ2UgJiZcclxuICAgICAgICAoZXZlbnQuZGF0YS50YXJnZXQgPT09IHRoaXMubmFtZSB8fCB0eXBlb2YgZXZlbnQuZGF0YS50YXJnZXQgPT09ICd1bmRlZmluZWQnKSkge1xyXG4gICAgICAgIHRoaXMuaGFuZGxlTWVzc2FnZShldmVudC5kYXRhKTtcclxuICAgIH1cclxufTtcclxuXHJcbk1hbmFnZXIucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHtcclxuICAgIHRoaXMudW5MaXN0ZW4oKTtcclxufTtcclxuXHJcbk1hbmFnZXIucHJvdG90eXBlLmxpc3RlbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5saXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50KXtcclxuICAgICAgICB0aGlzLnJlY2VpdmVNZXNzYWdlKGV2ZW50KTtcclxuICAgIH0uYmluZCh0aGlzKTtcclxuXHJcbiAgICB3aW5kb3cudG9wLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLmxpc3RlbmVyLCBmYWxzZSk7XHJcbn07XHJcblxyXG5NYW5hZ2VyLnByb3RvdHlwZS51bkxpc3RlbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgd2luZG93LnRvcC5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgdGhpcy5saXN0ZW5lcik7XHJcbiAgICB0aGlzLmxpc3RlbmVyID0gdW5kZWZpbmVkO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFNlbmQgYSBtZXNzYWdlIHRvIGEgQ2xpZW50LCBpZiBubyB0YXJnZXQgaXMgc3BlY2lmaWVkIHNlbmQgdG8gYWxsLlxyXG4gKiBAcGFyYW0gdHlwZSB0aGUgbWVzc2FnZSB0eXBlIHRvIHVzZSBiYXNlZCB0aGF0IGRlc2NyaWJlcyB0aGUgZmVhdHVyZSwgZWcgc3VibWl0LCBzZW5kLCBsb2dvdXRcclxuICogQHBhcmFtIGRhdGEgdGhlIG9hdFxyXG4gKiBAcGFyYW0gdGFyZ2V0XHJcbiAqL1xyXG5NYW5hZ2VyLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24gKHR5cGUsIGRhdGEsIHRhcmdldCkge1xyXG4gICAgdmFyIG1lc3NhZ2UgPSBuZXcgRnJhbWVNZXNzYWdlKHR5cGUsIGRhdGEsIHRoaXMubmFtZSwgdGFyZ2V0LCBNYW5hZ2VyTWVzc2FnZSk7XHJcbiAgICB3aW5kb3cudG9wLnBvc3RNZXNzYWdlKG1lc3NhZ2UsIGRvY3VtZW50LmxvY2F0aW9uLm9yaWdpbik7XHJcbn07XHJcblxyXG4vKipcclxuICogUmVjZWl2ZSBhIG1lc3NhZ2Ugb24gYSBNYW5hZ2VyIGluc3RhbmNlLiBUaGUgY2FsbGJhY2sgd2lsbCByZWNpZXZlIHRoZSBkYXRhXHJcbiAqIHZhbHVlIHNlbnQgd2l0aCBNYW5hZ2VyLnByb3RvdHlwZS5zZW5kKClcclxuICogQHBhcmFtIHR5cGVcclxuICogQHBhcmFtIGNhbGxiYWNrXHJcbiAqL1xyXG5NYW5hZ2VyLnByb3RvdHlwZS5yZWNlaXZlID0gZnVuY3Rpb24gKHR5cGUsIGNhbGxiYWNrKSB7XHJcbiAgICBpZiAoIWZpbHRlckJ5S2V5VmFsdWUodGhpcy5oYW5kbGVycywgJ3R5cGUnLCB0eXBlKSkge1xyXG4gICAgICAgIHRoaXMuaGFuZGxlcnMucHVzaCh7XHJcbiAgICAgICAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFja1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdZb3UgYWxyZWFkeSBoYXZlIGEgY2FsbGJhY2sgZm9yIHR5cGUnLCB0eXBlKTtcclxuICAgIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBBZGQgYSBuZXcgZnJhbWUgdG8gdGhlIE1hbmFnZXIgaW5zdGFuY2UuXHJcbiAqXHJcbiAqIEBwYXJhbSBuYW1lIHRoZSB1bmlxdWUgbmFtZSB0byBtYW5hZ2UgYW5kIHJlY2lldmUgbWVzc2FnZXNcclxuICogQHBhcmFtIHNyYyB0aGUgc3JjIHVybCB0aGF0IGlzIGdpdmVuIHRvIHRoZSBpZnJhbWUvd2Vidmlld1xyXG4gKiBAcGFyYW0gb3B0aW9ucyBhbiBvYmplY3Qgd2l0aCB2YWx1ZXMgZm9yIHN0eWxlLCBhdHRyaWJ1dGVzIGFuZCB1cmwgYXJndW1lbnRzIGZvciB0aGUgc3JjXHJcbiAqIEByZXR1cm5zIHsqfVxyXG4gKi9cclxuTWFuYWdlci5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKG5hbWUsIHNyYywgb3B0aW9ucykge1xyXG4gICAgdmFyIGV4aXN0aW5nID0gZmlsdGVyQnlLZXlWYWx1ZSh0aGlzLmZyYW1lcywgJ25hbWUnLCBuYW1lKTtcclxuICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignTWFuYWdlci5hZGQoKSB0aGVyZSBpcyBhbHJlYWR5IGEgZnJhbWUgbmFtZWQnLFxyXG4gICAgICAgICAgICBuYW1lLCAnaW4gdGhlIGZyYW1lcicsIHRoaXMubmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xyXG4gICAgfVxyXG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XHJcblxyXG4gICAgaWYgKCFpc0RlZmluZWQob3B0aW9ucy5zdHlsZSkpIHtcclxuICAgICAgICBvcHRpb25zLnN0eWxlID0gdGhpcy5zdHlsZTtcclxuICAgIH1cclxuICAgIGlmICghaXNEZWZpbmVkKG9wdGlvbnMuYXBwZW5kKSkge1xyXG4gICAgICAgIG9wdGlvbnMuYXBwZW5kID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIGlmICghaXNEZWZpbmVkKG9wdGlvbnMucGVyc2lzdGVudCkpIHtcclxuICAgICAgICBvcHRpb25zLnBlcnNpc3RlbnQgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHZhciBmcmFtZSA9IG5ldyBGcmFtZShDbGllbnRNZXNzYWdlLCBuYW1lLCBzcmMsIG9wdGlvbnMpO1xyXG4gICAgdGhpcy5mcmFtZXMucHVzaChmcmFtZSk7XHJcblxyXG4gICAgcmV0dXJuIGZyYW1lO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIE9wZW4gYSBmcmFtZSBieSBuYW1lIGFuZCBjbG9zZSBhbnkgb3BlbmVkIGZyYW1lcy5cclxuICpcclxuICogQHBhcmFtIG5hbWVcclxuICogQHBhcmFtIG9wdGlvbnNcclxuICovXHJcbk1hbmFnZXIucHJvdG90eXBlLm9wZW4gPSBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykge1xyXG4gICAgdmFyIGV4aXN0aW5nID0gdGhpcy5nZXRGcmFtZShuYW1lKTtcclxuICAgIGlmICghZXhpc3RpbmcpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdNYW5hZ2VyIG9wZW4oKSB0aGVyZSBpcyBubyBmcmFtZSB3aXRoIHRoYXQgbmFtZScsIG5hbWUpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmZvY3VzICYmIHRoaXMuZm9jdXMgIT09IGV4aXN0aW5nKSB7XHJcbiAgICAgICAgdGhpcy5jbG9zZUZyYW1lKHRoaXMuZm9jdXMpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mb2N1cyA9IGV4aXN0aW5nO1xyXG5cclxuICAgIGlmIChvcHRpb25zKSB7XHJcbiAgICAgICAgbWVyZ2VPcHRpb25zKHRoaXMuZm9jdXMub3B0aW9ucywgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm9wZW5GcmFtZSh0aGlzLmZvY3VzKTtcclxuXHJcbiAgICB0aGlzLm9wZW5lZC5kaXNwYXRjaChleGlzdGluZyk7XHJcblxyXG4gICAgcmV0dXJuIGV4aXN0aW5nO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIE9wZW4gYSBmcmFtZSBieSBuYW1lIGFuZCBpbnN0ZWFkIG9mIGNsb3NpbmcgYW55IG9wZW5lZCBmcmFtZXMsXHJcbiAqIHRoaXMgZnJhbWUgd2lsbCBpbnN0ZWFkIG9wZW4gYXQgYSB6SW5kZXggYWJvdmUgdGhlIGV4aXN0aW5nIG9wZW5lZCBmcmFtZS5cclxuICpcclxuICogQHBhcmFtIG5hbWVcclxuICogQHBhcmFtIG9wdGlvbnNcclxuICovXHJcbk1hbmFnZXIucHJvdG90eXBlLm9wZW5BYm92ZSA9IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7XHJcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcclxuICAgIG9wdGlvbnMuc3R5bGUgPSBvcHRpb25zLnN0eWxlIHx8IHt9O1xyXG5cclxuICAgIHZhciBleGlzdGluZyA9IHRoaXMuZ2V0RnJhbWUobmFtZSk7XHJcbiAgICBpZiAoIWV4aXN0aW5nKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignTWFuYWdlciBvcGVuKCkgdGhlcmUgaXMgbm8gZnJhbWUgd2l0aCB0aGF0IG5hbWUnLCBuYW1lKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoIW9wdGlvbnMuc3R5bGUuekluZGV4KSB7XHJcbiAgICAgICAgb3B0aW9ucy5zdHlsZS56SW5kZXggPSBleGlzdGluZy5zdHlsZS56SW5kZXggKyAxO1xyXG4gICAgfVxyXG4gICAgdGhpcy5vcGVuRnJhbWUoZXhpc3RpbmcsIG9wdGlvbnMpO1xyXG5cclxuICAgIHJldHVybiBleGlzdGluZztcclxufTtcclxuXHJcbk1hbmFnZXIucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24gKG5hbWUpIHtcclxuICAgIHZhciBleGlzdGluZyA9IHRoaXMuZ2V0RnJhbWUobmFtZSk7XHJcbiAgICBpZiAoIWV4aXN0aW5nKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdNYW5hZ2VyIGNsb3NlKCkgdGhlcmUgaXMgbm8gZnJhbWUgd2l0aCB0aGF0IG5hbWUnLCBuYW1lKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNsb3NlRnJhbWUoZXhpc3RpbmcpO1xyXG4gICAgdGhpcy5mb2N1cyA9IG51bGw7XHJcblxyXG4gICAgdGhpcy5jbG9zZWQuZGlzcGF0Y2goZXhpc3RpbmcpO1xyXG59O1xyXG5cclxuTWFuYWdlci5wcm90b3R5cGUuaGFuZGxlTWVzc2FnZSA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7XHJcbiAgICB2YXIgcmVzdWx0ID0gZmlsdGVyQnlLZXlWYWx1ZSh0aGlzLmhhbmRsZXJzLCAndHlwZScsIG1lc3NhZ2UudHlwZSk7XHJcbiAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgcmVzdWx0LmNhbGxiYWNrLmFwcGx5KHRoaXMsIFttZXNzYWdlLmRhdGFdKTtcclxuICAgIH1cclxufTtcclxuXHJcbk1hbmFnZXIucHJvdG90eXBlLm9wZW5GcmFtZSA9IGZ1bmN0aW9uIChmcmFtZSwgb3B0aW9ucykge1xyXG4gICAgLy9tZXJnZSBleGlzdGluZyBvcHRpb25zIHdpdGggb3ZlcnJpZGVcclxuICAgIGlmIChvcHRpb25zKSB7XHJcbiAgICAgICAgbWVyZ2VPcHRpb25zKGZyYW1lLm9wdGlvbnMsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmKGZyYW1lLm9wdGlvbnMucGVyc2lzdGVudCkge1xyXG4gICAgICAgIHRoaXMuc2V0UGVyc2lzdGVudEZyYW1lKGZyYW1lKTtcclxuXHJcbiAgICB9IGVsc2UgaWYgKCFmcmFtZS5mcmFtZUVsZW1lbnQpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZUZyYW1lRWxlbWVudChmcmFtZSk7XHJcbiAgICAgICAgaWYgKGZyYW1lLm9wdGlvbnMuYXBwZW5kKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLmNvbnRhaW5lcjtcclxuICAgICAgICAgICAgaWYgKGZyYW1lLm9wdGlvbnMucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSBmcmFtZS5vcHRpb25zLnBhcmVudDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwcmVwZW5kRWxlbWVudChwYXJlbnQsIGZyYW1lLmZyYW1lRWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ01hbmFnZXInLCB0aGlzLm5hbWUsICdhbHJlYWR5IGhhcycsIGZyYW1lLm5hbWUsICdvcGVuJyk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5NYW5hZ2VyLnByb3RvdHlwZS5jbG9zZUZyYW1lID0gZnVuY3Rpb24gKGZyYW1lKSB7XHJcbiAgICBpZihmcmFtZS5vcHRpb25zLnBlcnNpc3RlbnQgJiYgdGhpcy5wZXJzaXN0ZW50RnJhbWUgIT09IG51bGwpIHtcclxuICAgICAgICB0aGlzLnBlcnNpc3RlbnRGcmFtZS5zcmMgPSAnYWJvdXQ6YmxhbmsnO1xyXG4gICAgICAgIHRoaXMucGVyc2lzdGVudEZyYW1lLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcclxuXHJcbiAgICB9IGVsc2UgaWYoZnJhbWUuZnJhbWVFbGVtZW50KSB7XHJcbiAgICAgICAgdmFyIGNoaWxkV2luZG93ID0gZnJhbWUuZnJhbWVFbGVtZW50LmNvbnRlbnRXaW5kb3c7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2ZyYW1lIG9wdGlvbnMnLCBmcmFtZS5vcHRpb25zKTtcclxuICAgICAgICAvL2lmIChmcmFtZS5vcHRpb25zLmFuZ3VsYXJBcHBJZCAmJiBjaGlsZFdpbmRvdy5hbmd1bGFyKSB7XHJcbiAgICAgICAgLy8gICAgYW5ndWxhckNsb3NlRnJhbWVXaW5kb3coZnJhbWUpO1xyXG4gICAgICAgIC8vfVxyXG4gICAgICAgIC8vZWxzZSB7XHJcbiAgICAgICAgICAgIGNsb3NlRnJhbWVXaW5kb3coZnJhbWUpO1xyXG4gICAgICAgIC8vfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ01hbmFnZXInLCB0aGlzLm5hbWUsICdmcmFtZScsIGZyYW1lLm5hbWUsICdpcyBub3Qgb3BlbiB0byBjbG9zZScpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuTWFuYWdlci5wcm90b3R5cGUuZ2V0RnJhbWUgPSBmdW5jdGlvbiAoZnJhbWUpIHtcclxuICAgIHZhciBleGlzdGluZ0ZyYW1lO1xyXG4gICAgaWYgKHR5cGVvZiBmcmFtZSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICBleGlzdGluZ0ZyYW1lID0gdGhpcy5nZXRGcmFtZUJ5TmFtZShmcmFtZSlcclxuICAgIH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoZnJhbWUpLm5hbWUpIHtcclxuICAgICAgICBleGlzdGluZ0ZyYW1lID0gdGhpcy5mcmFtZXMuaW5kZXhPZihmcmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGV4aXN0aW5nRnJhbWU7XHJcbn07XHJcblxyXG5NYW5hZ2VyLnByb3RvdHlwZS5nZXRGcmFtZUJ5TmFtZSA9IGZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICB2YXIgZnJhbWU7XHJcbiAgICB2YXIgcmVzdWx0ID0gdGhpcy5mcmFtZXMuZmlsdGVyKGZ1bmN0aW9uIChmcmFtZSkge1xyXG4gICAgICAgIHJldHVybiBmcmFtZS5uYW1lID09PSBuYW1lO1xyXG4gICAgfSk7XHJcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICBmcmFtZSA9IHJlc3VsdFswXTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZnJhbWU7XHJcbn07XHJcblxyXG5NYW5hZ2VyLnByb3RvdHlwZS5zZXRQZXJzaXN0ZW50RnJhbWUgPSBmdW5jdGlvbihmcmFtZSkge1xyXG4gICAgaWYodGhpcy5wZXJzaXN0ZW50RnJhbWUgPT09IG51bGwpIHtcclxuICAgICAgICB0aGlzLnBlcnNpc3RlbnRGcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpO1xyXG4gICAgICAgIHByZXBlbmRFbGVtZW50KHRoaXMuY29udGFpbmVyLCB0aGlzLnBlcnNpc3RlbnRGcmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHNyYyA9IGZyYW1lLnNyYztcclxuICAgIHZhciBvcHRpb25zID0gZnJhbWUub3B0aW9ucztcclxuICAgIG9wdGlvbnMuYXJndW1lbnRzID0gb3B0aW9ucy5hcmd1bWVudHMgfHwge307XHJcbiAgICBvcHRpb25zLnN0eWxlID0gb3B0aW9ucy5zdHlsZSB8fCB7fTtcclxuICAgIG9wdGlvbnMuYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlcyB8fCB7fTtcclxuICAgIHZhciBwYXJhbWV0ZXJzID0gY3JlYXRlVXJsQXJncyhvcHRpb25zLmFyZ3VtZW50cyk7XHJcbiAgICB2YXIgcGFyYW1zID0gJyZuYW1lPScgKyBmcmFtZS5uYW1lICsgJyYnICsgcGFyYW1ldGVycztcclxuICAgIHZhciBvcmlnaW4gPSAnP29yaWdpbj0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpO1xyXG5cclxuICAgIHNldEVsZW1lbnRTdHlsZXModGhpcy5wZXJzaXN0ZW50RnJhbWUsIG9wdGlvbnMuc3R5bGUpO1xyXG4gICAgc2V0RWxlbWVudEF0dHJpYnV0ZXModGhpcy5wZXJzaXN0ZW50RnJhbWUsIG9wdGlvbnMuYXR0cmlidXRlcyk7XHJcblxyXG4gICAgdGhpcy5wZXJzaXN0ZW50RnJhbWUuaWQgPSBmcmFtZS5uYW1lO1xyXG4gICAgdGhpcy5wZXJzaXN0ZW50RnJhbWUuc3JjID0gc3JjICsgb3JpZ2luICsgcGFyYW1zO1xyXG4gICAgdGhpcy5wZXJzaXN0ZW50RnJhbWUuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcclxuICAgIHRoaXMucGVyc2lzdGVudEZyYW1lLnNhbmRib3ggPSAnYWxsb3ctZm9ybXMgYWxsb3ctc2NyaXB0cyBhbGxvdy1zYW1lLW9yaWdpbic7XHJcbiAgICBmcmFtZS5mcmFtZUVsZW1lbnQgPSB0aGlzLnBlcnNpc3RlbnRGcmFtZTtcclxuXHJcbn07XHJcblxyXG5NYW5hZ2VyLnByb3RvdHlwZS5jcmVhdGVGcmFtZUVsZW1lbnQgPSBmdW5jdGlvbiAoZnJhbWUpIHtcclxuICAgIHZhciBzcmMgPSBmcmFtZS5zcmM7XHJcbiAgICB2YXIgb3B0aW9ucyA9IGZyYW1lLm9wdGlvbnM7XHJcbiAgICBvcHRpb25zLmFyZ3VtZW50cyA9IG9wdGlvbnMuYXJndW1lbnRzIHx8IHt9O1xyXG4gICAgb3B0aW9ucy5zdHlsZSA9IG9wdGlvbnMuc3R5bGUgfHwge307XHJcbiAgICBvcHRpb25zLmF0dHJpYnV0ZXMgPSBvcHRpb25zLmF0dHJpYnV0ZXMgfHwge307XHJcbiAgICB2YXIgcGFyYW1ldGVycyA9IGNyZWF0ZVVybEFyZ3Mob3B0aW9ucy5hcmd1bWVudHMpO1xyXG4gICAgdmFyIHBhcmFtcyA9ICcmbmFtZT0nICsgZnJhbWUubmFtZSArICcmJyArIHBhcmFtZXRlcnM7XHJcbiAgICB2YXIgb3JpZ2luID0gJz9vcmlnaW49JyArIGVuY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5sb2NhdGlvbi5ocmVmKTtcclxuXHJcbiAgICAvL3RvZG8gd2VidmlldyBtcy1hcHAtd2Vidmlld1xyXG4gICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpO1xyXG5cclxuICAgIHNldEVsZW1lbnRTdHlsZXMoaWZyYW1lLCBvcHRpb25zLnN0eWxlKTtcclxuICAgIHNldEVsZW1lbnRBdHRyaWJ1dGVzKGlmcmFtZSwgb3B0aW9ucy5hdHRyaWJ1dGVzKTtcclxuXHJcbiAgICBpZnJhbWUuaWQgPSBmcmFtZS5uYW1lO1xyXG4gICAgaWZyYW1lLnNyYyA9IHNyYyArIG9yaWdpbiArIHBhcmFtcztcclxuICAgIGlmcmFtZS5zYW5kYm94ID0gJ2FsbG93LWZvcm1zIGFsbG93LXNjcmlwdHMgYWxsb3ctc2FtZS1vcmlnaW4nO1xyXG4gICAgZnJhbWUuZnJhbWVFbGVtZW50ID0gaWZyYW1lO1xyXG5cclxuICAgIHJldHVybiBmcmFtZTtcclxufTtcclxuXHJcblxyXG5cclxuTWFuYWdlci5wcm90b3R5cGUuY3JlYXRlRnJhbWVDb250YWluZXIgPSBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7XHJcbiAgICB2YXIgY29udGFpbmVyO1xyXG4gICAgaWYgKCFlbGVtZW50RXhpc3RzQnlDbGFzc05hbWUoY2xhc3NOYW1lKSkge1xyXG4gICAgICAgIGNvbnRhaW5lciA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICBjb250YWluZXIuY2xhc3NOYW1lID0gY2xhc3NOYW1lO1xyXG4gICAgICAgIGNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICdmaXhlZCc7XHJcbiAgICAgICAgY29udGFpbmVyLnN0eWxlLnRvcCA9IDA7XHJcbiAgICAgICAgY29udGFpbmVyLnN0eWxlLmxlZnQgPSAwO1xyXG4gICAgICAgIGNvbnRhaW5lci5zdHlsZS56SW5kZXggPSB0aGlzLnpJbmRleDtcclxuICAgICAgICBwcmVwZW5kRWxlbWVudCh3aW5kb3cuZG9jdW1lbnQuYm9keSwgY29udGFpbmVyKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjb250YWluZXI7XHJcbn07IiwiZnVuY3Rpb24gQ2xpZW50KCkge1xyXG4gICAgdGhpcy5oYW5kbGVycyA9IFtdO1xyXG5cclxuICAgIHRoaXMucGFyYW1zID0gcGFyc2VQYXJhbXMoKTtcclxuICAgIHZhciBuYW1lID0gZmlsdGVyQnlLZXlWYWx1ZSh0aGlzLnBhcmFtcywgJ25hbWUnLCAnbmFtZScsIHRydWUpO1xyXG4gICAgdmFyIG9yaWdpbiA9IGZpbHRlckJ5S2V5VmFsdWUodGhpcy5wYXJhbXMsICduYW1lJywgJ29yaWdpbicpO1xyXG4gICAgaWYgKCFpc0RlZmluZWQobmFtZSkgfHwgIWlzRGVmaW5lZChvcmlnaW4pKSB7XHJcbiAgICAgICAgY29uc29sZS5pbmZvKCdBIEZyYW1lciBDbGllbnQgd2lsbCBub3Qgd29yayB3aXRob3V0IHRoZSBjb3JyZWN0IG9yaWdpbiBhbmQgbmFtZSB1cmwgYXJncywgb3JpZ2luIGFuZCBuYW1lJyk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5uYW1lID0gbmFtZS5kYXRhO1xyXG4gICAgdGhpcy5vcmlnaW4gPSBvcmlnaW4uZGF0YTtcclxuXHJcbiAgICB0aGlzLmxpc3RlbigpO1xyXG59XHJcblxyXG5DbGllbnQucHJvdG90eXBlLnJlY2VpdmVNZXNzYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICBpZiAoZXZlbnQgJiZcclxuICAgICAgICBldmVudC5vcmlnaW4gJiZcclxuICAgICAgICBldmVudC5vcmlnaW4gIT09IHdpbmRvdy50b3AuZG9jdW1lbnQubG9jYXRpb24ub3JpZ2luKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChldmVudC5kYXRhLm1lc3NlbmdlciA9PT0gTWFuYWdlck1lc3NhZ2UgJiZcclxuICAgICAgICAoZXZlbnQuZGF0YS50YXJnZXQgPT09IHRoaXMubmFtZSB8fFxyXG4gICAgICAgIHR5cGVvZiBldmVudC5kYXRhLnRhcmdldCA9PT0gJ3VuZGVmaW5lZCcpKSB7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlKGV2ZW50LmRhdGEpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuQ2xpZW50LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XHJcbiAgICB0aGlzLnVuTGlzdGVuKCk7XHJcbn07XHJcblxyXG5DbGllbnQucHJvdG90eXBlLmxpc3RlbiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgdGhpcy5saXN0ZW5lciA9IGZ1bmN0aW9uKGV2ZW50KXtcclxuICAgICAgICB0aGlzLnJlY2VpdmVNZXNzYWdlKGV2ZW50KTtcclxuICAgIH0uYmluZCh0aGlzKTtcclxuXHJcbiAgICB3aW5kb3cudG9wLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLmxpc3RlbmVyLCBmYWxzZSk7XHJcbn07XHJcblxyXG5DbGllbnQucHJvdG90eXBlLnVuTGlzdGVuID0gZnVuY3Rpb24oKSB7XHJcbiAgICB3aW5kb3cudG9wLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCB0aGlzLmxpc3RlbmVyKTtcclxuICAgIHRoaXMubGlzdGVuZXIgPSB1bmRlZmluZWQ7XHJcbn07XHJcblxyXG5DbGllbnQucHJvdG90eXBlLmhhbmRsZU1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xyXG4gICAgdmFyIHJlc3VsdCA9IGZpbHRlckJ5S2V5VmFsdWUodGhpcy5oYW5kbGVycywgJ3R5cGUnLCBtZXNzYWdlLnR5cGUpO1xyXG4gICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgIHJlc3VsdC5jYWxsYmFjay5hcHBseSh0aGlzLCBbbWVzc2FnZS5kYXRhXSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5DbGllbnQucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbiAodHlwZSwgZGF0YSwgdGFyZ2V0KSB7XHJcbiAgICB2YXIgbWVzc2FnZSA9IG5ldyBGcmFtZU1lc3NhZ2UodHlwZSwgZGF0YSwgdGhpcy5uYW1lLCB0YXJnZXQsIENsaWVudE1lc3NhZ2UpO1xyXG4gICAgd2luZG93LnRvcC5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLm9yaWdpbik7XHJcbn07XHJcblxyXG5DbGllbnQucHJvdG90eXBlLnJlY2VpdmUgPSBmdW5jdGlvbiAodHlwZSwgY2FsbGJhY2spIHtcclxuICAgIGlmICghZmlsdGVyQnlLZXlWYWx1ZSh0aGlzLmhhbmRsZXJzLCAndHlwZScsIHR5cGUpKSB7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVycy5wdXNoKHtcclxuICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrXHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1lvdSBhbHJlYWR5IGhhdmUgYSBjYWxsYmFjayBmb3IgdHlwZScsIG5hbWUpO1xyXG4gICAgfVxyXG59OyIsImZ1bmN0aW9uIGFuZ3VsYXJDbG9zZUZyYW1lV2luZG93KGZyYW1lKSB7XHJcbiAgICB2YXIgY2hpbGRXaW5kb3cgPSBmcmFtZS5mcmFtZUVsZW1lbnQuY29udGVudFdpbmRvdztcclxuICAgIHZhciBuZ0FwcCA9IGNoaWxkV2luZG93LmFuZ3VsYXIuZWxlbWVudChjaGlsZFdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcmFtZS5vcHRpb25zLmFuZ3VsYXJBcHBJZCkpO1xyXG4gICAgY29uc29sZS5sb2coJ25nQXBwJywgbmdBcHApO1xyXG5cclxuICAgIHZhciBpbmplY3RvciA9IGNoaWxkV2luZG93LmFuZ3VsYXIuZWxlbWVudChuZ0FwcCkuaW5qZWN0b3IoKTtcclxuICAgIGRlc3Ryb3lBbGxTY29wZXMoKTtcclxuXHJcbiAgICBmdW5jdGlvbiBkZXN0cm95QWxsU2NvcGVzKCkge1xyXG4gICAgICAgIHZhciByb290U2NvcGUgPSBpbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKTtcclxuICAgICAgICByb290U2NvcGUuJGJyb2FkY2FzdChcIiRkZXN0cm95XCIpO1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjbG9zZUZyYW1lV2luZG93KGZyYW1lKTtcclxuICAgICAgICB9LCAwKTtcclxuICAgIH1cclxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==